#!/bin/sh

export CC=gcc
export CXX=g++

SCRIPT="$1"
PACKAGE="${SCRIPT##*/}"
PACKAGE="${PACKAGE%-mini.sh}"
PACKAGE="${PACKAGE%-nano.sh}"
export PACKAGE

if [ "$PACKAGE" != 'qt6-base' ]; then
	export CMAKE_C_COMPILER_LAUNCHER=ccache
	export CMAKE_CXX_COMPILER_LAUNCHER=ccache
else
	export CMAKE_C_COMPILER_LAUNCHER=sccache
	export CMAKE_CXX_COMPILER_LAUNCHER=sccache
fi

export PATH="$PWD:$PWD/bin:$PATH:/usr/bin/core_perl"
chmod +x "$PWD"/bin/* "$PWD"/*.sh

if [ "$FORCE_BUILD" = "1" ]; then
	echo "Forcing build!"
	echo "Packages will be built and released regardless of version mismatch"
fi

if [ -n "$ONE_PACKAGE" ] && [ "$ONE_PACKAGE" != "$PACKAGE" ]; then
	:> ~/OPERATION_ABORTED
	exit 0
fi

COUNT=0
while :; do
	if "$SCRIPT"; then
		if [ -f ~/OPERATION_ABORTED ]; then
			exit 0
		fi
		>&2 echo "----------------------------------------"
		>&2 echo "Package built successfully!"
		>&2 echo "----------------------------------------"
		break
	else
		>&2 echo "----------------------------------------"
		>&2 echo "Failed to build package, trying again..."
		>&2 echo "----------------------------------------"
		COUNT=$(( COUNT + 1))
	fi
	if [ "$COUNT" -ge 3 ]; then
		>&2 echo "----------------------------------------"
		>&2 echo "Failed to build package 3 times"
		>&2 echo "----------------------------------------"
		exit 1
	fi
done

if [ "$PACKAGE" != 'qt6-base' ]; then
	ccache -s -v
else
	sccache --show-stats
fi

mkdir ./dist
sha256sum ./*.pkg.tar.*
mv ./*.pkg.tar.* ./dist
